<!-- saved from url=(0014)about:internet -->
<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,1" id="srcline1"> 1</a></span><span class="line"><span class="keyword">function</span> <span class="var type1" id="S2T1U3">acc_com</span> = ndi_control(<span class="var type1" id="S3T2U6">x</span>,<span class="var type1" id="S4T1U7">vel_dot_ref</span>,<span class="var type1" id="S5T1U8">vel_ff</span>,<span class="var type1" id="S6T3U9">max_bank</span>,<span class="var type1" id="S7T3U10">mass</span>,<span class="var type1" id="S8T3U11">L</span>,<span class="var type1" id="S9T3U12">delta</span>,<span class="var type1" id="S10T3U13">kT_max</span>,<span class="var type1" id="S11T3U14">kMT</span>,<span class="var type1" id="S12T3U15">gf</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,2" id="srcline2"> 2</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,3" id="srcline3"> 3</a></span><span class="line"><span class="mxinfo " id="T3:U12"><span class="var type1" id="S13T3U18">sd</span> = <span class="mxinfo  sgl" id="T3:U14">sin(<span class="var type1 sgl" id="S9T3U21">delta</span>)</span></span>; <span class="mxinfo " id="T3:U16"><span class="var type1" id="S15T3U24">cd</span> = <span class="mxinfo  sgl" id="T3:U18">cos(<span class="var type1 sgl" id="S9T3U27">delta</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,4" id="srcline4"> 4</a></span><span class="line"><span class="mxinfo  sgl" id="T3:U20"><span class="var type1" id="S17T3U30">h</span> = <span class="mxinfo  sgl" id="T3:U22"><span class="var type1" id="S15T3U32">cd</span> / (<span class="mxinfo  sgl" id="T3:U24">2 * <span class="var type1 sgl" id="S12T3U36">gf</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,5" id="srcline5"> 5</a></span><span class="line"><span class="mxinfo  sgl" id="T3:U26"><span class="var type1" id="S18T3U39">m</span> = <span class="mxinfo  sgl" id="T3:U28"><span class="mxinfo  sgl" id="T3:U29"><span class="var type1" id="S13T3U42">sd</span> * <span class="var type1 sgl" id="S11T3U43">kMT</span></span> / (<span class="mxinfo  sgl" id="T3:U32">10 * <span class="var type1 sgl" id="S12T3U47">gf</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,6" id="srcline6"> 6</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,7" id="srcline7"> 7</a></span><span class="line"><span class="mxinfo " id="T4:U34"><span class="var type1" id="S19T4U50">Tnm</span> = <span class="mxinfo  sgl" id="T4:U36">[<span class="mxinfo " id="T5:U37"><span class="mxinfo  sgl" id="T3:U38">-1</span>,    <span class="mxinfo  sgl" id="T3:U39">0</span>    <span class="mxinfo " id="T3:U40">1*<span class="var type1" id="S15T3U58">cd</span></span> ,     <span class="mxinfo  sgl" id="T3:U42">0</span>,      <span class="mxinfo  sgl" id="T3:U43">0</span>,      <span class="mxinfo  sgl" id="T3:U44">-1*<span class="var type1" id="S15T3U64">cd</span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,8" id="srcline8"> 8</a></span><span class="line">    <span class="mxinfo " id="T5:U46"><span class="mxinfo  sgl" id="T3:U47"><span class="var type1 sgl" id="S17T3U67">h</span>+<span class="var type1 sgl" id="S18T3U68">m</span></span>,    <span class="mxinfo  sgl" id="T3:U50"><span class="var type1 sgl" id="S17T3U70">h</span>+<span class="var type1 sgl" id="S18T3U71">m</span></span>    <span class="mxinfo  sgl" id="T3:U53">1</span>    , <span class="mxinfo  sgl" id="T3:U54">-1</span>,   <span class="mxinfo  sgl" id="T3:U55">1</span>,      <span class="mxinfo  sgl" id="T3:U56">-1</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,9" id="srcline9"> 9</a></span><span class="line">    <span class="mxinfo " id="T5:U57"><span class="mxinfo  sgl" id="T3:U58">0</span>,   <span class="mxinfo  sgl" id="T3:U59">-1</span>    <span class="mxinfo " id="T3:U60">1*<span class="var type1" id="S15T3U84">cd</span></span> ,     <span class="mxinfo  sgl" id="T3:U62">0</span>,     <span class="mxinfo  sgl" id="T3:U63">0</span>,       <span class="mxinfo " id="T3:U64">1*<span class="var type1" id="S15T3U89">cd</span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,10" id="srcline10">10</a></span><span class="line">    <span class="mxinfo " id="T5:U66"><span class="mxinfo  sgl" id="T3:U67">-(<span class="mxinfo  sgl" id="T3:U68"><span class="var type1 sgl" id="S17T3U94">h</span>-<span class="var type1 sgl" id="S18T3U95">m</span></span>)</span>,    (<span class="mxinfo  sgl" id="T3:U71"><span class="var type1 sgl" id="S17T3U98">h</span>-<span class="var type1 sgl" id="S18T3U99">m</span></span>)    <span class="mxinfo  sgl" id="T3:U74">1</span>    , <span class="mxinfo  sgl" id="T3:U75">-1</span>,  <span class="mxinfo  sgl" id="T3:U76">-1</span>,       <span class="mxinfo  sgl" id="T3:U77">1</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,11" id="srcline11">11</a></span><span class="line">    <span class="mxinfo " id="T5:U78"><span class="mxinfo  sgl" id="T3:U79">1</span>,    <span class="mxinfo  sgl" id="T3:U80">0</span>    <span class="mxinfo " id="T3:U81">1*<span class="var type1" id="S15T3U111">cd</span></span> , <span class="mxinfo  sgl" id="T3:U83">-0</span>,         <span class="mxinfo  sgl" id="T3:U84">0</span>,     <span class="mxinfo  sgl" id="T3:U85">-1*<span class="var type1" id="S15T3U118">cd</span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,12" id="srcline12">12</a></span><span class="line">    <span class="mxinfo " id="T5:U87"><span class="mxinfo  sgl" id="T3:U88">-(<span class="mxinfo  sgl" id="T3:U89"><span class="var type1 sgl" id="S17T3U123">h</span>+<span class="var type1 sgl" id="S18T3U124">m</span></span>)</span>,   <span class="mxinfo  sgl" id="T3:U92">-(<span class="mxinfo  sgl" id="T3:U93"><span class="var type1 sgl" id="S17T3U128">h</span>+<span class="var type1 sgl" id="S18T3U129">m</span></span>)</span>    <span class="mxinfo  sgl" id="T3:U96">1</span>    , <span class="mxinfo  sgl" id="T3:U97">1</span>,   <span class="mxinfo  sgl" id="T3:U98">-1</span>,      <span class="mxinfo  sgl" id="T3:U99">-1</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,13" id="srcline13">13</a></span><span class="line">    <span class="mxinfo " id="T5:U100"><span class="mxinfo  sgl" id="T3:U101">0</span>,    <span class="mxinfo  sgl" id="T3:U102">1</span>    <span class="mxinfo " id="T3:U103">1*<span class="var type1" id="S15T3U141">cd</span></span> ,     <span class="mxinfo  sgl" id="T3:U105">0</span>,      <span class="mxinfo  sgl" id="T3:U106">0</span>,       <span class="mxinfo " id="T3:U107">1*<span class="var type1" id="S15T3U146">cd</span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,14" id="srcline14">14</a></span><span class="line">    <span class="mxinfo " id="T5:U109"><span class="mxinfo  sgl" id="T3:U110"><span class="var type1 sgl" id="S17T3U149">h</span>-<span class="var type1 sgl" id="S18T3U150">m</span></span>,   <span class="mxinfo  sgl" id="T3:U113">-(<span class="mxinfo  sgl" id="T3:U114"><span class="var type1 sgl" id="S17T3U154">h</span>-<span class="var type1 sgl" id="S18T3U155">m</span></span>)</span>    <span class="mxinfo  sgl" id="T3:U117">1</span>    , <span class="mxinfo  sgl" id="T3:U118">1</span>,    <span class="mxinfo  sgl" id="T3:U119">1</span>,       <span class="mxinfo  sgl" id="T3:U120">1</span></span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,15" id="srcline15">15</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,16" id="srcline16">16</a></span><span class="line"><span class="mxinfo " id="T3:U121"><span class="var type1" id="S20T3U162">u</span> = <span class="mxinfo  sgl" id="T3:U123"><span class="var type1 sgl" id="S3T2U164">x</span>(<span class="mxinfo " id="T6:U125">1</span>)</span></span>; <span class="mxinfo " id="T3:U126"><span class="var type1" id="S21T3U168">v</span> = <span class="mxinfo  sgl" id="T3:U128"><span class="var type1 sgl" id="S3T2U170">x</span>(<span class="mxinfo " id="T6:U130">2</span>)</span></span>; <span class="mxinfo " id="T3:U131"><span class="var type1" id="S22T3U174">w</span> = <span class="mxinfo  sgl" id="T3:U133"><span class="var type1 sgl" id="S3T2U176">x</span>(<span class="mxinfo " id="T6:U135">3</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,17" id="srcline17">17</a></span><span class="line"><span class="mxinfo " id="T3:U136"><span class="var type1" id="S23T3U180">phi</span> = <span class="mxinfo " id="T3:U138"><span class="var type1 sgl" id="S3T2U182">x</span>(<span class="mxinfo " id="T6:U140">10</span>)</span></span>; <span class="mxinfo " id="T3:U141"><span class="var type1" id="S24T3U186">theta</span> = <span class="mxinfo " id="T3:U143"><span class="var type1 sgl" id="S3T2U188">x</span>(<span class="mxinfo " id="T6:U145">11</span>)</span></span>; <span class="mxinfo " id="T3:U146"><span class="var type1" id="S25T3U192">psi</span> = <span class="mxinfo " id="T3:U148"><span class="var type1 sgl" id="S3T2U194">x</span>(<span class="mxinfo " id="T6:U150">12</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,18" id="srcline18">18</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,19" id="srcline19">19</a></span><span class="line"><span class="mxinfo " id="T3:U151"><span class="var type1" id="S26T3U198">phi_wrap</span> = <span class="mxinfo  sgl" id="T3:U153">min(<span class="mxinfo  sgl" id="T3:U154">max(<span class="var type1" id="S23T3U203">phi</span>,<span class="mxinfo  sgl" id="T3:U156">-<span class="var type1 sgl" id="S6T3U205">max_bank</span></span>)</span>,<span class="var type1 sgl" id="S6T3U206">max_bank</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,20" id="srcline20">20</a></span><span class="line"><span class="mxinfo " id="T3:U159"><span class="var type1" id="S29T3U209">theta_wrap</span> = <span class="mxinfo  sgl" id="T3:U161">min(<span class="mxinfo  sgl" id="T3:U162">max(<span class="var type1" id="S24T3U214">theta</span>,<span class="mxinfo  sgl" id="T3:U164">-<span class="var type1 sgl" id="S6T3U216">max_bank</span></span>)</span>,<span class="var type1 sgl" id="S6T3U217">max_bank</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,21" id="srcline21">21</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,22" id="srcline22">22</a></span><span class="line"><span class="comment">% Frequently used functions</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,23" id="srcline23">23</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,24" id="srcline24">24</a></span><span class="line"><span class="mxinfo " id="T1:U167"><span class="var type1" id="S30T1U220">F</span> = <span class="mxinfo  sgl" id="T1:U169"><span class="mxinfo  sgl" id="T7:U170"><span class="fcn" id="F154N7:B223">dhdx_calc</span>(<span class="var type1" id="S20T3U224">u</span>,<span class="var type1" id="S21T3U225">v</span>,<span class="var type1" id="S22T3U226">w</span>,<span class="var type1" id="S23T3U227">phi</span>,<span class="var type1" id="S24T3U228">theta</span>,<span class="var type1" id="S25T3U229">psi</span>)</span> * <span class="mxinfo  sgl" id="T8:U177"><span class="fcn" id="F266N2:B231">OC_fx</span>(<span class="mxinfo " id="T2:U178"><span class="var type1 sgl" id="S3T2U233">x</span>(1:12)</span>,<span class="var type1 sgl" id="S7T3U237">mass</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,25" id="srcline25">25</a></span><span class="line"><span class="mxinfo " id="T9:U181"><span class="var type1" id="S33T9U240">G</span> = <span class="mxinfo  sgl" id="T9:U183"><span class="mxinfo  sgl" id="T7:U184"><span class="fcn" id="F154N7:B243">dhdx_calc</span>(<span class="var type1" id="S20T3U244">u</span>,<span class="var type1" id="S21T3U245">v</span>,<span class="var type1" id="S22T3U246">w</span>,<span class="var type1" id="S26T3U247">phi_wrap</span>,<span class="var type1" id="S29T3U248">theta_wrap</span>,<span class="var type1" id="S25T3U249">psi</span>)</span> * <span class="mxinfo  sgl" id="T10:U191"><span class="fcn" id="F429N3:B251">OC_gx</span>(<span class="mxinfo " id="T2:U192"><span class="var type1 sgl" id="S3T2U253">x</span>(1:12)</span>,<span class="var type1 sgl" id="S8T3U257">L</span>,<span class="var type1 sgl" id="S9T3U258">delta</span>,<span class="var type1 sgl" id="S10T3U259">kT_max</span>,<span class="var type1 sgl" id="S7T3U260">mass</span>,<span class="var type1" id="S19T4U261">Tnm</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,26" id="srcline26">26</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,27" id="srcline27">27</a></span><span class="line"><span class="comment">% NDI control law</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,28" id="srcline28">28</a></span><span class="line"><span class="mxinfo  sgl" id="T1:U199"><span class="var type1" id="S2T1U264">acc_com</span> = <span class="mxinfo  sgl" id="T1:U201"><span class="mxinfo  sgl" id="T9:U202">pinv(<span class="var type1" id="S33T9U268">G</span>)</span> * (<span class="mxinfo  sgl" id="T1:U204"><span class="mxinfo  sgl" id="T1:U205"><span class="var type1 sgl" id="S5T1U272">vel_ff</span> - <span class="var type1" id="S30T1U273">F</span></span> + <span class="var type1 sgl" id="S4T1U274">vel_dot_ref</span></span>)</span></span>; <span class="comment">% u = G^(-1)*[rdot - F + K*e];</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,29" id="srcline29">29</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,30" id="srcline30">30</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,31" id="srcline31">31</a></span><span class="line"></span></span>
</pre>
