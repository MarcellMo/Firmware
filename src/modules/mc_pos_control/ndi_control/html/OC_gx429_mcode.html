<!-- saved from url=(0014)about:internet -->
<pre class="code">
<span class="srcline"><span class="lineno"><a href="78,1" id="srcline1"> 1</a></span><span class="line"><span class="keyword">function</span> <span class="var type1" id="S2T10U3">gmatrix</span> = OC_gx(<span class="var type1" id="S3T2U6">x</span>,<span class="var type1" id="S4T3U7">L</span>,<span class="var type1" id="S5T3U8">delta</span>,<span class="var type1" id="S6T3U9">kT_max</span>,<span class="var type1" id="S7T3U10">mass</span>,<span class="var type1" id="S8T4U11">Tnm</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="78,2" id="srcline2"> 2</a></span><span class="line"><span class="comment">% Control part of state derivatives xdot = f(x)+gmatrix(x)*um</span></span></span>
<span class="srcline"><span class="lineno"><a href="78,3" id="srcline3"> 3</a></span><span class="line"><span class="comment">% L = 1; % length from arm!</span></span></span>
<span class="srcline"><span class="lineno"><a href="78,4" id="srcline4"> 4</a></span><span class="line"><span class="comment">% delta = 40 * pi/180;% motor tilt angle</span></span></span>
<span class="srcline"><span class="lineno"><a href="78,5" id="srcline5"> 5</a></span><span class="line"><span class="comment">% kT_max = 11; % Max thrust</span></span></span>
<span class="srcline"><span class="lineno"><a href="78,6" id="srcline6"> 6</a></span><span class="line"><span class="comment">% mass = 3.5000; % mass copter </span></span></span>
<span class="srcline"><span class="lineno"><a href="78,7" id="srcline7"> 7</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="78,8" id="srcline8"> 8</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="78,9" id="srcline9"> 9</a></span><span class="line"><span class="mxinfo " id="T1:U8"><span class="var type1" id="S9T1U14">VKb</span> = <span class="mxinfo " id="T1:U10"><span class="var type1" id="S3T2U16">x</span>(1:3)</span></span>;     <span class="comment">% Kinematic velocity in body frame</span></span></span>
<span class="srcline"><span class="lineno"><a href="78,10" id="srcline10">10</a></span><span class="line"><span class="mxinfo " id="T1:U12"><span class="var type1" id="S10T1U22">omegab</span> = <span class="mxinfo  sgl" id="T1:U14"><span class="var type1" id="S3T2U24">x</span>(7:9)</span></span>;  <span class="comment">% Angular velocity vector in body frame</span></span></span>
<span class="srcline"><span class="lineno"><a href="78,11" id="srcline11">11</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="78,12" id="srcline12">12</a></span><span class="line"><span class="comment">% Velocities of rotors with respect to air</span></span></span>
<span class="srcline"><span class="lineno"><a href="78,13" id="srcline13">13</a></span><span class="line"><span class="comment">% VA = VK - VW</span></span></span>
<span class="srcline"><span class="lineno"><a href="78,14" id="srcline14">14</a></span><span class="line"><span class="comment">% define cross product matrix</span></span></span>
<span class="srcline"><span class="lineno"><a href="78,15" id="srcline15">15</a></span><span class="line"><span class="mxinfo " id="T1:U16"><span class="var type1" id="S11T1U30">omegaA</span> = <span class="var type1" id="S10T1U31">omegab</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="78,16" id="srcline16">16</a></span><span class="line"><span class="mxinfo " id="T9:U19"><span class="var type1" id="S12T9U34">omegaA_mat</span> = <span class="mxinfo  sgl" id="T9:U21">[   <span class="mxinfo " id="T37:U22"><span class="mxinfo  sgl" id="T3:U23">0</span>          <span class="mxinfo  sgl" id="T3:U24">-<span class="mxinfo " id="T3:U25"><span class="var type1" id="S11T1U40">omegaA</span>(<span class="mxinfo " id="T6:U27">3</span>)</span></span>   <span class="mxinfo " id="T3:U28"><span class="var type1" id="S11T1U43">omegaA</span>(<span class="mxinfo " id="T6:U30">2</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="78,17" id="srcline17">17</a></span><span class="line">              <span class="mxinfo " id="T37:U31"><span class="mxinfo " id="T3:U32"><span class="var type1" id="S11T1U47">omegaA</span>(<span class="mxinfo " id="T6:U34">3</span>)</span>      <span class="mxinfo  sgl" id="T3:U35">0</span>          <span class="mxinfo  sgl" id="T3:U36">-<span class="mxinfo " id="T3:U37"><span class="var type1" id="S11T1U52">omegaA</span>(<span class="mxinfo " id="T6:U39">1</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="78,18" id="srcline18">18</a></span><span class="line">             <span class="mxinfo " id="T37:U40"><span class="mxinfo  sgl" id="T3:U41">-<span class="mxinfo " id="T3:U42"><span class="var type1" id="S11T1U57">omegaA</span>(<span class="mxinfo " id="T6:U44">2</span>)</span></span>      <span class="mxinfo " id="T3:U45"><span class="var type1" id="S11T1U60">omegaA</span>(<span class="mxinfo " id="T6:U47">1</span>)</span>      <span class="mxinfo  sgl" id="T3:U48">0</span></span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="78,19" id="srcline19">19</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="78,20" id="srcline20">20</a></span><span class="line"><span class="mxinfo " id="T45:U49"><span class="var type1" id="S13T45U65">R</span> = <span class="mxinfo " id="T45:U51">zeros(3,8)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="78,21" id="srcline21">21</a></span><span class="line"><span class="mxinfo  sgl" id="T1:U52"><span class="mxinfo  sgl" id="T1:U53"><span class="var type1 sgl" id="S13T45U73">R</span>(<span class="mxinfo " id="T48:U55">:</span>,<span class="mxinfo " id="T6:U56">1</span>)</span> = <span class="mxinfo " id="T1:U57">[<span class="var type1" id="S4T3U78">L</span>; <span class="mxinfo  sgl" id="T3:U59">0</span>; <span class="mxinfo  sgl" id="T3:U60">0</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="78,22" id="srcline22">22</a></span><span class="line"><span class="mxinfo  sgl" id="T1:U61"><span class="mxinfo  sgl" id="T1:U62"><span class="var type1 sgl" id="S13T45U86">R</span>(<span class="mxinfo " id="T48:U64">:</span>,<span class="mxinfo " id="T6:U65">2</span>)</span> = <span class="mxinfo " id="T1:U66">[<span class="mxinfo  sgl" id="T3:U67"><span class="var type1" id="S4T3U92">L</span>/sqrt(2)</span> ;  <span class="mxinfo  sgl" id="T3:U69"><span class="var type1" id="S4T3U98">L</span>/sqrt(2)</span>; <span class="mxinfo  sgl" id="T3:U71">0</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="78,23" id="srcline23">23</a></span><span class="line"><span class="mxinfo  sgl" id="T1:U72"><span class="mxinfo  sgl" id="T1:U73"><span class="var type1 sgl" id="S13T45U107">R</span>(<span class="mxinfo " id="T48:U75">:</span>,<span class="mxinfo " id="T6:U76">3</span>)</span> = <span class="mxinfo " id="T1:U77">[<span class="mxinfo  sgl" id="T3:U78">0</span>; <span class="var type1" id="S4T3U114">L</span>; <span class="mxinfo  sgl" id="T3:U80">0</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="78,24" id="srcline24">24</a></span><span class="line"><span class="mxinfo  sgl" id="T1:U81"><span class="mxinfo  sgl" id="T1:U82"><span class="var type1 sgl" id="S13T45U120">R</span>(<span class="mxinfo " id="T48:U84">:</span>,<span class="mxinfo " id="T6:U85">4</span>)</span> = <span class="mxinfo " id="T1:U86">[<span class="mxinfo  sgl" id="T3:U87"><span class="mxinfo  sgl" id="T3:U88">-<span class="var type1" id="S4T3U127">L</span></span>/sqrt(2)</span>;  <span class="mxinfo  sgl" id="T3:U90"><span class="var type1" id="S4T3U133">L</span>/sqrt(2)</span>; <span class="mxinfo  sgl" id="T3:U92">0</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="78,25" id="srcline25">25</a></span><span class="line"><span class="mxinfo  sgl" id="T1:U93"><span class="mxinfo  sgl" id="T1:U94"><span class="var type1 sgl" id="S13T45U142">R</span>(<span class="mxinfo " id="T48:U96">:</span>,<span class="mxinfo " id="T6:U97">5</span>)</span> = <span class="mxinfo " id="T1:U98">[<span class="mxinfo  sgl" id="T3:U99">-<span class="var type1" id="S4T3U148">L</span></span>; <span class="mxinfo  sgl" id="T3:U101">0</span>; <span class="mxinfo  sgl" id="T3:U102">0</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="78,26" id="srcline26">26</a></span><span class="line"><span class="mxinfo  sgl" id="T1:U103"><span class="mxinfo  sgl" id="T1:U104"><span class="var type1 sgl" id="S13T45U156">R</span>(<span class="mxinfo " id="T48:U106">:</span>,<span class="mxinfo " id="T6:U107">6</span>)</span> = <span class="mxinfo " id="T1:U108">[<span class="mxinfo  sgl" id="T3:U109"><span class="mxinfo  sgl" id="T3:U110">-<span class="var type1" id="S4T3U163">L</span></span>/sqrt(2)</span>; <span class="mxinfo  sgl" id="T3:U112"><span class="mxinfo  sgl" id="T3:U113">-<span class="var type1" id="S4T3U170">L</span></span>/sqrt(2)</span>; <span class="mxinfo  sgl" id="T3:U115">0</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="78,27" id="srcline27">27</a></span><span class="line"><span class="mxinfo  sgl" id="T1:U116"><span class="mxinfo  sgl" id="T1:U117"><span class="var type1 sgl" id="S13T45U179">R</span>(<span class="mxinfo " id="T48:U119">:</span>,<span class="mxinfo " id="T6:U120">7</span>)</span> = <span class="mxinfo " id="T1:U121">[<span class="mxinfo  sgl" id="T3:U122">0</span>; <span class="mxinfo  sgl" id="T3:U123">-<span class="var type1" id="S4T3U187">L</span></span>; <span class="mxinfo  sgl" id="T3:U125">0</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="78,28" id="srcline28">28</a></span><span class="line"><span class="mxinfo  sgl" id="T1:U126"><span class="mxinfo  sgl" id="T1:U127"><span class="var type1 sgl" id="S13T45U193">R</span>(<span class="mxinfo " id="T48:U129">:</span>,<span class="mxinfo " id="T6:U130">8</span>)</span> = <span class="mxinfo " id="T1:U131">[<span class="mxinfo  sgl" id="T3:U132"><span class="var type1" id="S4T3U199">L</span>/sqrt(2)</span> ; <span class="mxinfo  sgl" id="T3:U134"><span class="mxinfo  sgl" id="T3:U135">-<span class="var type1" id="S4T3U206">L</span></span>/sqrt(2)</span>; <span class="mxinfo  sgl" id="T3:U137">0</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="78,29" id="srcline29">29</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="78,30" id="srcline30">30</a></span><span class="line"><span class="mxinfo " id="T45:U138"><span class="var type1" id="S16T45U214">VrotA</span> = <span class="mxinfo  sgl" id="T45:U140"><span class="mxinfo  sgl" id="T45:U141">(<span class="var type1" id="S9T1U218">VKb</span>)*ones(1,8)</span> + <span class="mxinfo  sgl" id="T45:U143"><span class="var type1" id="S12T9U224">omegaA_mat</span>*<span class="var type1 sgl" id="S13T45U225">R</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="78,31" id="srcline31">31</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="78,32" id="srcline32">32</a></span><span class="line"><span class="mxinfo " id="T3:U146"><span class="var type1" id="S18T3U228">sd</span> = <span class="mxinfo  sgl" id="T3:U148">sin(<span class="var type1" id="S5T3U231">delta</span>)</span></span>; <span class="mxinfo " id="T3:U150"><span class="var type1" id="S20T3U234">cd</span> = <span class="mxinfo  sgl" id="T3:U152">cos(<span class="var type1" id="S5T3U237">delta</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="78,33" id="srcline33">33</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="78,34" id="srcline34">34</a></span><span class="line"><span class="comment">% Matrix for forces:  Frotb = Fmat * un;</span></span></span>
<span class="srcline"><span class="lineno"><a href="78,35" id="srcline35">35</a></span><span class="line"><span class="mxinfo " id="T3:U154"><span class="var type1" id="S22T3U240">kv</span> = <span class="mxinfo " id="T3:U156">single(0.05)</span></span>; <span class="comment">% Thrust reduction factor, s/m;</span></span></span>
<span class="srcline"><span class="lineno"><a href="78,36" id="srcline36">36</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="78,37" id="srcline37">37</a></span><span class="line"><span class="mxinfo  sgl" id="T44:U157"><span class="var type1" id="S24T44U246">k</span> = <span class="mxinfo  sgl" id="T44:U159"><span class="var type1" id="S6T3U248">kT_max</span> * (<span class="mxinfo  sgl" id="T44:U161">1+<span class="mxinfo  sgl" id="T44:U162"><span class="var type1" id="S22T3U253">kv</span>*<span class="mxinfo  sgl" id="T44:U164"><span class="var type1" id="S16T45U255">VrotA</span>(<span class="mxinfo " id="T6:U166">3</span>,<span class="mxinfo " id="T49:U167">:</span>)</span></span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="78,38" id="srcline38">38</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="78,39" id="srcline39">39</a></span><span class="line"><span class="comment">% Rot  1        2     3        4     5         6     7          8</span></span></span>
<span class="srcline"><span class="lineno"><a href="78,40" id="srcline40">40</a></span><span class="line"><span class="mxinfo " id="T45:U168"><span class="var type1" id="S25T45U260">Fmat</span> = <span class="mxinfo  sgl" id="T45:U170">[<span class="mxinfo " id="T44:U171"><span class="mxinfo  sgl" id="T3:U172"><span class="mxinfo  sgl" id="T3:U173">-<span class="mxinfo  sgl" id="T3:U174"><span class="var type1 sgl" id="S24T44U266">k</span>(<span class="mxinfo " id="T6:U176">1</span>)</span></span>*<span class="var type1" id="S18T3U268">sd</span></span>  <span class="mxinfo  sgl" id="T3:U178">0</span>     <span class="mxinfo  sgl" id="T3:U179">0</span>        <span class="mxinfo  sgl" id="T3:U180">0</span>     <span class="mxinfo  sgl" id="T3:U181"><span class="mxinfo  sgl" id="T3:U182"><span class="var type1 sgl" id="S24T44U274">k</span>(<span class="mxinfo " id="T6:U184">5</span>)</span>*<span class="var type1" id="S18T3U276">sd</span></span>   <span class="mxinfo  sgl" id="T3:U186">0</span>     <span class="mxinfo  sgl" id="T3:U187">0</span>          <span class="mxinfo  sgl" id="T3:U188">0</span></span>;    <span class="comment">%Fxb</span></span></span>
<span class="srcline"><span class="lineno"><a href="78,41" id="srcline41">41</a></span><span class="line">    <span class="mxinfo " id="T44:U189"><span class="mxinfo  sgl" id="T3:U190">0</span>        <span class="mxinfo  sgl" id="T3:U191">0</span>    <span class="mxinfo  sgl" id="T3:U192"><span class="mxinfo  sgl" id="T3:U193">-<span class="mxinfo  sgl" id="T3:U194"><span class="var type1 sgl" id="S24T44U286">k</span>(<span class="mxinfo " id="T6:U196">3</span>)</span></span>*<span class="var type1" id="S18T3U288">sd</span></span>  <span class="mxinfo  sgl" id="T3:U198">0</span>     <span class="mxinfo  sgl" id="T3:U199">0</span>         <span class="mxinfo  sgl" id="T3:U200">0</span>     <span class="mxinfo  sgl" id="T3:U201"><span class="mxinfo  sgl" id="T3:U202"><span class="var type1 sgl" id="S24T44U294">k</span>(<span class="mxinfo " id="T6:U204">7</span>)</span>*<span class="var type1" id="S18T3U296">sd</span></span>    <span class="mxinfo  sgl" id="T3:U206">0</span></span>;    <span class="comment">%Fyb</span></span></span>
<span class="srcline"><span class="lineno"><a href="78,42" id="srcline42">42</a></span><span class="line">    <span class="mxinfo " id="T44:U207"><span class="mxinfo  sgl" id="T3:U208"><span class="mxinfo  sgl" id="T3:U209">-<span class="mxinfo  sgl" id="T3:U210"><span class="var type1 sgl" id="S24T44U302">k</span>(<span class="mxinfo " id="T6:U212">1</span>)</span></span>*<span class="var type1" id="S20T3U304">cd</span></span> <span class="mxinfo  sgl" id="T3:U214">-<span class="mxinfo  sgl" id="T3:U215"><span class="var type1 sgl" id="S24T44U307">k</span>(<span class="mxinfo " id="T6:U217">2</span>)</span></span> <span class="mxinfo  sgl" id="T3:U218"><span class="mxinfo  sgl" id="T3:U219">-<span class="mxinfo  sgl" id="T3:U220"><span class="var type1 sgl" id="S24T44U312">k</span>(<span class="mxinfo " id="T6:U222">3</span>)</span></span>*<span class="var type1" id="S20T3U314">cd</span></span> <span class="mxinfo  sgl" id="T3:U224">-<span class="mxinfo  sgl" id="T3:U225"><span class="var type1 sgl" id="S24T44U317">k</span>(<span class="mxinfo " id="T6:U227">4</span>)</span></span> <span class="mxinfo  sgl" id="T3:U228"><span class="mxinfo  sgl" id="T3:U229">-<span class="mxinfo  sgl" id="T3:U230"><span class="var type1 sgl" id="S24T44U322">k</span>(<span class="mxinfo " id="T6:U232">5</span>)</span></span>*<span class="var type1" id="S20T3U324">cd</span></span>  <span class="mxinfo  sgl" id="T3:U234">-<span class="mxinfo  sgl" id="T3:U235"><span class="var type1 sgl" id="S24T44U327">k</span>(<span class="mxinfo " id="T6:U237">6</span>)</span></span> <span class="mxinfo  sgl" id="T3:U238"><span class="mxinfo  sgl" id="T3:U239">-<span class="mxinfo  sgl" id="T3:U240"><span class="var type1 sgl" id="S24T44U332">k</span>(<span class="mxinfo " id="T6:U242">7</span>)</span></span>*<span class="var type1" id="S20T3U334">cd</span></span>   <span class="mxinfo  sgl" id="T3:U244">-<span class="mxinfo  sgl" id="T3:U245"><span class="var type1 sgl" id="S24T44U337">k</span>(<span class="mxinfo " id="T6:U247">8</span>)</span></span></span>]</span></span>;<span class="comment">%Fzb</span></span></span>
<span class="srcline"><span class="lineno"><a href="78,43" id="srcline43">43</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="78,44" id="srcline44">44</a></span><span class="line"><span class="comment">% gmatrix dimension = 6 (outputs) x 8 (inputs um)</span></span></span>
<span class="srcline"><span class="lineno"><a href="78,45" id="srcline45">45</a></span><span class="line"><span class="mxinfo " id="T47:U248"><span class="var type1" id="S26T47U341">gmatrix_n2</span> = <span class="mxinfo  sgl" id="T47:U250">[<span class="mxinfo  sgl" id="T45:U251"><span class="var type1" id="S25T45U345">Fmat</span>/<span class="var type1" id="S7T3U346">mass</span></span>;        <span class="comment">% [p;q;r] dot</span></span></span>
<span class="srcline"><span class="lineno"><a href="78,46" id="srcline46">46</a></span><span class="line">             <span class="mxinfo  sgl" id="T45:U254">zeros(3,8)</span>]</span></span>;            <span class="comment">% [phi;theta;psi] dot</span></span></span>
<span class="srcline"><span class="lineno"><a href="78,47" id="srcline47">47</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="78,48" id="srcline48">48</a></span><span class="line"><span class="mxinfo " id="T10:U255"><span class="var type1" id="S2T10U354">gmatrix</span> = <span class="mxinfo  sgl" id="T10:U257"><span class="var type1" id="S26T47U356">gmatrix_n2</span> * <span class="mxinfo  sgl" id="T46:U259"><span class="var type1" id="S8T4U358">Tnm</span>(<span class="mxinfo " id="T49:U261">:</span>,<span class="mxinfo " id="T48:U262">1:3</span>)</span></span></span>;</span></span>
</pre>
